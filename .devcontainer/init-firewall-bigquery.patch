# Proposed Changes to init-firewall.sh for BigQuery Integration Tests

## Summary

Add Google Cloud API endpoints to the allowed domains list to enable BigQuery integration tests.

## Required Google Cloud Endpoints

For BigQuery to work, we need access to:
1. `oauth2.googleapis.com` - OAuth2 token endpoint for authentication
2. `bigquery.googleapis.com` - BigQuery API endpoint
3. `www.googleapis.com` - Google APIs discovery service (optional but recommended)

## Proposed Change

Add the following domains to the allowed domains loop in init-firewall.sh:

```bash
# Around line 67-82, add these three domains to the list:

for domain in \
    "registry.npmjs.org" \
    "api.anthropic.com" \
    "sentry.io" \
    "statsig.anthropic.com" \
    "statsig.com" \
    "marketplace.visualstudio.com" \
    "vscode.blob.core.windows.net" \
    "update.code.visualstudio.com" \
    "pypi.org" \
    "files.pythonhosted.org" \
    "download.docker.com" \
    "registry-1.docker.io" \
    "auth.docker.io" \
    "production.cloudflare.docker.com" \
    "mail.kylegehring.com" \
    "oauth2.googleapis.com" \           # NEW: For Google Cloud authentication
    "bigquery.googleapis.com" \         # NEW: For BigQuery API
    "www.googleapis.com"; do            # NEW: For Google APIs (optional)
    echo "Resolving $domain..."
    # ... rest of loop
done
```

## Security Considerations

✅ **Minimal Access**: Only adds 3 specific Google Cloud endpoints
✅ **Maintains Restrictions**: All other traffic still blocked
✅ **Read-Only**: BigQuery integration only reads public datasets
✅ **No Broad Access**: Not allowing *.googleapis.com (wildcard)
✅ **Auditable**: Changes are explicit and documented

## Alternative: Conditional Enable

If you want to make BigQuery access optional (only when testing), you could use an environment variable:

```bash
# At the beginning of init-firewall.sh
ENABLE_BIGQUERY=${ENABLE_BIGQUERY:-false}

# In the domains list
for domain in \
    # ... existing domains ...
    $(if [ "$ENABLE_BIGQUERY" = "true" ]; then
        echo "oauth2.googleapis.com"
        echo "bigquery.googleapis.com"
        echo "www.googleapis.com"
    fi); do
```

Then enable only when needed:
```bash
# In devcontainer.json
"containerEnv": {
    "ENABLE_BIGQUERY": "true",  # Add this line
    // ... other env vars
}
```

## Testing the Changes

After modifying init-firewall.sh:

1. Rebuild the devcontainer
2. Test Google Cloud connectivity:
   ```bash
   curl -v https://oauth2.googleapis.com 2>&1 | grep "Connected"
   curl -v https://bigquery.googleapis.com 2>&1 | grep "Connected"
   ```
3. Run BigQuery integration tests:
   ```bash
   export BIGQUERY_PROJECT_ID=ai-text-rpg
   export GOOGLE_APPLICATION_CREDENTIALS=/workspace/.bigquery_credentials.json
   ./test_bigquery.sh
   ```

## Recommendation

I recommend the **conditional enable** approach because:
- ✅ Maintains strict firewall by default
- ✅ Only enables BigQuery when explicitly requested
- ✅ Makes it clear this is for testing purposes
- ✅ Easy to enable/disable without editing the firewall script
- ✅ Can be enabled per-container via environment variable
